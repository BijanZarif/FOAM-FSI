#!/bin/bash

set -e

# Ensure the script is executed in this directory
DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
cd $DIR

# Define which versions of the different packages are used
export SCONS_VERSION=2.3.4
export BOOST_VERSION=1_55_0
export BOOST_VERSION_DOT=1.55.0

# Download SCons
if [ ! -d "scons-${SCONS_VERSION}" ]; then
	wget -O scons-${SCONS_VERSION}.tar.gz http://downloads.sourceforge.net/project/scons/scons/${SCONS_VERSION}/scons-${SCONS_VERSION}.tar.gz
	tar -zxf scons-${SCONS_VERSION}.tar.gz
	rm -f scons-${SCONS_VERSION}.tar.gz
fi

# Download Boost
if [ ! -d "boost_${BOOST_VERSION}" ]; then
    wget -O boost_${BOOST_VERSION}.tar.bz2 http://downloads.sourceforge.net/project/boost/boost/${BOOST_VERSION_DOT}/boost_${BOOST_VERSION}.tar.bz2
    tar jxf boost_${BOOST_VERSION}.tar.bz2
    rm -f boost_${BOOST_VERSION}.tar.bz2
fi

# Install scons
cd scons-${SCONS_VERSION}
python setup.py install --home=~
cd ..

# Set environment variables necessary for building preCICE

export BOOST_ROOT=`pwd`/boost_${BOOST_VERSION}
export PRECICE_BOOST_ROOT=${BOOST_ROOT}
export PRECICE_MPI_LIB=mpi
export PRECICE_MPI_LIB_PATH=${MPI_HOME}/lib
export PRECICE_MPI_INC_PATH=${MPI_HOME}/include
export CPLUS_INCLUDE_PATH=`pwd`/eigen

# Build preCICE

cd precice
scons -j 4 build=release python=off petsc=off
scons -j 4 build=release python=off petsc=off solibll


mkdir -p ${FOAM_USER_LIBBIN}
mkdir -p ${FOAM_USER_APPBIN}

SHARED_LIBRARY=libprecice.so

cp build/last/${SHARED_LIBRARY} ${FOAM_USER_LIBBIN}/
cp build/last/binprecice ${FOAM_USER_APPBIN}/
