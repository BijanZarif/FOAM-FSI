#!/bin/bash

set -e

# Assume that preCICE has been built before, and boost is already downloaded.

VERSION=0.5.2

if [ "$(uname)" == "Darwin" ]; then
    extension=dylib
else
    extension=so
fi

if [ ! -e ${FOAM_USER_LIBBIN}/libyaml-cpp.${extension}.0.5.2 ]; then

    # Define which versions of the different packages are used

    export BOOST_VERSION=1_53_0

    rm -rf yaml-cpp*

    rm -rf yaml-cpp-${VERSION}*

    wget -O yaml-cpp-${VERSION}.tar.gz https://github.com/jbeder/yaml-cpp/archive/release-${VERSION}.tar.gz

    tar -zxvf yaml-cpp-${VERSION}.tar.gz
    rm -f yaml-cpp-${VERSION}.tar.gz

    ln -s yaml-cpp-release-${VERSION} yaml-cpp
    rm -f boost
    ln -s boost_${BOOST_VERSION} boost

    export BOOST_ROOT=`pwd`/boost_${BOOST_VERSION}

    cd yaml-cpp

    mkdir build

    cd build

    if [ "$(uname)" == "Darwin" ]; then
        CC=gcc-mp-4.9 CXX=g++-mp-4.9 cmake -DBUILD_SHARED_LIBS=ON ..
    else
        cmake -DBUILD_SHARED_LIBS=ON ..
    fi

    make -j 4

    # Copy the shared library to $FOAM_USER_LIBBIN
    mkdir -p ${FOAM_USER_LIBBIN}
    cp libyaml-cpp.${extension}.0.5.2 ${FOAM_USER_LIBBIN}/
    cp libyaml-cpp.${extension}.0.5 ${FOAM_USER_LIBBIN}/
    cp libyaml-cpp.${extension} ${FOAM_USER_LIBBIN}/

fi
