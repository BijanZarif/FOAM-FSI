#!/bin/bash

set -e
set -x

METIS_VERSION=5.1.0
PARMETIS_VERSION=4.0.3
PETSC_VERSION=3.6.2
DEALII_VERSION=8.3.0

if [ ! -d "metis" ]; then

  mkdir metis
  cd metis

  rm -rf metis-${METIS_VERSION}*

  wget http://glaros.dtc.umn.edu/gkhome/fetch/sw/metis/metis-5.1.0.tar.gz

  tar -zxf metis-${METIS_VERSION}.tar.gz
  rm metis-${METIS_VERSION}.tar.gz

  cd metis-${METIS_VERSION}

  export CC=mpicc
  export CXX=mpicxx

  make config prefix=`pwd`/build

  make install

  cd ../../

fi

if [ ! -d "parmetis" ]; then

  mkdir parmetis
  cd parmetis

  rm -rf parmetis-${PARMETIS_VERSION}*

  wget http://glaros.dtc.umn.edu/gkhome/fetch/sw/parmetis/parmetis-${PARMETIS_VERSION}.tar.gz

  tar -zxf parmetis-${PARMETIS_VERSION}.tar.gz
  rm parmetis-${PARMETIS_VERSION}.tar.gz

  cd parmetis-${PARMETIS_VERSION}

  export CC=mpicc
  export CXX=mpicxx

  make config prefix=`pwd`/build

  make install

  cd ../../

fi

if [ ! -d "petsc" ]; then

  mkdir petsc
  cd petsc

  rm -rf petsc-${PETSC_VERSION}*

  wget http://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-${PETSC_VERSION}.tar.gz

  tar -zxf petsc-${PETSC_VERSION}.tar.gz

  rm petsc-${PETSC_VERSION}.tar.gz

  cd petsc-${PETSC_VERSION}

  export PETSC_DIR=`pwd`
  export PETSC_ARCH=x86_64

  ./config/configure.py --with-shared=1 --with-x=0 --with-mpi=1 --download-hypre=1 --download-mumps --download-scalapack --download-ptscotch --download-suitesparse

  make

  make test

  cd ../../

fi

if [ ! -d "dealii" ]; then

  mkdir dealii
  cd dealii

  wget https://github.com/dealii/dealii/releases/download/v${DEALII_VERSION}/dealii-${DEALII_VERSION}.tar.gz

  tar -zxf dealii-${DEALII_VERSION}.tar.gz

  rm dealii-${DEALII_VERSION}.tar.gz

  export PETSC_DIR=`pwd`/../petsc/petsc-${PETSC_VERSION}
  export PETSC_ARCH=x86_64
  export CC=mpicc
  export CXX=mpicxx
  export F77=mpif77
  export F90=mpif90
  export METIS_DIR=`pwd`/../metis/metis-${METIS_VERSION}
  export PARMETIS_DIR=`pwd`/../parmetis/parmetis-${PARMETIS_VERSION}

  echo $PETSC_DIR

  cd dealii-${DEALII_VERSION}

  mkdir build
  mkdir bin
  cd build

  cmake -DCMAKE_INSTALL_PREFIX=`pwd`/../bin ..

  make -j 4 install

  make -j 4 test

  cd ../../../

fi

cd deal-fsi

rm -rf Makefile CMakeFiles cmake_install.cmake CMakeCache.txt
rm -f boost eigen
ln -s ../boost boost
ln -s ../eigen eigen

cmake -DDEAL_II_DIR=../dealii/dealii-${DEALII_VERSION}/bin/ .

make release
