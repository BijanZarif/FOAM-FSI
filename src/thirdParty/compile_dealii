#!/bin/bash

set -e
set -x

METIS_VERSION=5.1.0
PARMETIS_VERSION=4.0.3
PETSC_VERSION=3.6.3
DEALII_VERSION=8.3.0
BOOST_VERSION=1_55_0
BOOST_VERSION_DOT=1.55.0
export PETSC_ARCH=x86_64

if [ ! -d "boost_${BOOST_VERSION}" ]; then
    rm -rf boost*
    wget -O boost_${BOOST_VERSION}.tar.bz2 http://downloads.sourceforge.net/project/boost/boost/${BOOST_VERSION_DOT}/boost_${BOOST_VERSION}.tar.bz2
    tar jxf boost_${BOOST_VERSION}.tar.bz2
    rm -f boost_${BOOST_VERSION}.tar.bz2
fi

rm -f boost
ln -s boost_${BOOST_VERSION} boost

if [ ! -d "metis-${METIS_VERSION}" ]; then

  rm -rf metis*

  wget http://glaros.dtc.umn.edu/gkhome/fetch/sw/metis/metis-${METIS_VERSION}.tar.gz

  tar -zxf metis-${METIS_VERSION}.tar.gz
  rm metis-${METIS_VERSION}.tar.gz

  cd metis-${METIS_VERSION}

  export CC=mpicc
  export CXX=mpicxx

  make config prefix=`pwd`/build

  make install

  cd ../

fi

rm -f metis
ln -s metis-${METIS_VERSION} metis

if [ ! -d "parmetis-${PARMETIS_VERSION}" ]; then

  rm -rf parmetis*

  wget http://glaros.dtc.umn.edu/gkhome/fetch/sw/parmetis/parmetis-${PARMETIS_VERSION}.tar.gz

  tar -zxf parmetis-${PARMETIS_VERSION}.tar.gz
  rm parmetis-${PARMETIS_VERSION}.tar.gz

  cd parmetis-${PARMETIS_VERSION}

  export CC=mpicc
  export CXX=mpicxx

  make config prefix=`pwd`/build

  make install

  cd ../

fi

rm -f parmetis
ln -s parmetis-${PARMETIS_VERSION} parmetis

if [ ! -d "dealii-${DEALII_VERSION}" ]; then

  rm -rf dealii*

  wget https://github.com/dealii/dealii/releases/download/v${DEALII_VERSION}/dealii-${DEALII_VERSION}.tar.gz

  tar -zxf dealii-${DEALII_VERSION}.tar.gz

  rm dealii-${DEALII_VERSION}.tar.gz

  export PETSC_DIR=`pwd`/petsc
  cd $PETSC_DIR
  cd ..
  export CC=mpicc
  export CXX=mpicxx
  export F77=mpif77
  export F90=mpif90
  export METIS_DIR=`pwd`/metis
  export PARMETIS_DIR=`pwd`/parmetis

  cd dealii-${DEALII_VERSION}

  mkdir build
  mkdir bin
  cd build

  cmake -DCMAKE_INSTALL_PREFIX=`pwd`/../bin ..

  make -j $WM_NCOMPPROCS install

  make -j $WM_NCOMPPROCS test

  cd ../..

fi

rm -f dealii
ln -s dealii-${DEALII_VERSION} dealii

cp dealii/bin/lib/libdeal* ${FOAM_LIBBIN}/

cd deal-fsi

rm -rf Makefile CMakeFiles cmake_install.cmake CMakeCache.txt
rm -f boost eigen
ln -s ../boost
ln -s ../eigen

cmake -DDEAL_II_DIR=../dealii/bin/ .

make
